# Модуль WebApp

Модуль WebApp представляет собой веб-приложение на основе Blazor Server, которое является точкой входа для пользователей eShop.

## Проекты модуля

### 1. WebApp

**Назначение:** Основное веб-приложение на Blazor Server.

**Ответственность:**
- **UI компоненты:**
  - Главная страница каталога товаров
  - Страница деталей товара
  - Корзина покупок
  - Страница оформления заказа
  - История заказов
  - Чат-бот с AI для поиска товаров
- **Сервисы:**
  - `CatalogService` - работа с каталогом товаров
  - `BasketService` - работа с корзиной (через gRPC)
  - `OrderingService` - работа с заказами
  - `IdentityService` - работа с аутентификацией
- **Аутентификация:**
  - Интеграция с Identity Server через OpenID Connect
  - Управление сессиями пользователей
- **AI интеграция:**
  - Чат-бот для поиска товаров
  - Интеграция с OpenAI или Ollama
  - Использование AI функций для работы с корзиной
- **Маршрутизация:**
  - Настройка маршрутов через Blazor Router
  - Обработка навигации
- **Проксирование:**
  - Проксирование запросов к изображениям товаров
  - Использование YARP для маршрутизации

**Зависимости:**
- `WebAppComponents` - переиспользуемые компоненты
- `eShop.ServiceDefaults` - базовые сервисы Aspire
- `EventBusRabbitMQ` - для интеграционных событий
- `Asp.Versioning.Http.Client` - клиент для версионированных API
- `Microsoft.AspNetCore.Authentication.OpenIdConnect` - аутентификация
- `Grpc.Net.ClientFactory` - клиент для gRPC
- `Aspire.Azure.AI.OpenAI` - интеграция с OpenAI (опционально)
- `CommunityToolkit.Aspire.OllamaSharp` - интеграция с Ollama (опционально)
- `Microsoft.Extensions.ServiceDiscovery.Yarp` - сервисное обнаружение

**Особенности:**
- Blazor Server для интерактивности
- Интеграция со всеми сервисами eShop
- AI-чат для умного поиска товаров
- Аутентификация через Identity Server
- Проксирование запросов к API

---

### 2. WebAppComponents

**Назначение:** Переиспользуемые Blazor компоненты.

**Ответственность:**
- **UI компоненты:**
  - Компоненты для отображения товаров
  - Компоненты корзины
  - Компоненты заказов
  - Общие компоненты (Layout, Navigation, etc.)
- **Сервисы:**
  - Сервисы для работы с состоянием
  - Сервисы для работы с данными

**Зависимости:**
- `Microsoft.AspNetCore.Components.Web` - базовые компоненты Blazor

**Особенности:**
- Переиспользуемые компоненты
- Изоляция UI логики
- Поддержка браузерной платформы

---

## Архитектура

```
┌─────────────────┐
│    WebApp       │ ← Blazor Server App
│  (User Interface)│
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
┌───▼───┐ ┌──▼──────────┐
│Catalog│ │   Basket     │
│  API  │ │  (gRPC)      │
└───────┘ └──────────────┘
    │
┌───▼──────────┐
│  Ordering    │
│     API      │
└──────────────┘
    │
┌───▼──────────┐
│  Identity    │
│   Server     │
└──────────────┘
```

## Основные потоки данных

### Просмотр каталога:
1. Пользователь открывает главную страницу
2. WebApp запрашивает товары через `CatalogService`
3. Товары отображаются на странице
4. Пользователь может фильтровать и искать товары

### Добавление в корзину:
1. Пользователь нажимает "Добавить в корзину"
2. WebApp вызывает gRPC метод `UpdateBasket` через `BasketService`
3. Корзина обновляется в Redis
4. UI обновляется с новым количеством товаров

### Оформление заказа:
1. Пользователь переходит на страницу оформления заказа
2. Заполняет данные доставки и оплаты
3. WebApp отправляет запрос в `OrderingService`
4. Создается заказ через Ordering API
5. Корзина очищается
6. Пользователь видит подтверждение заказа

### AI поиск:
1. Пользователь открывает чат-бот
2. Вводит запрос на естественном языке
3. `ChatState` обрабатывает запрос через AI
4. AI функции вызывают `CatalogService` для поиска
5. Результаты отображаются пользователю
6. Пользователь может добавить товары в корзину через AI

## Особенности реализации

- **Blazor Server:** Интерактивность без JavaScript
- **gRPC:** Высокопроизводительная коммуникация с Basket API
- **REST API:** Коммуникация с Catalog и Ordering API
- **AI интеграция:** Умный поиск через OpenAI/Ollama
- **Service Discovery:** Автоматическое обнаружение сервисов через Aspire
- **Аутентификация:** OpenID Connect для безопасного доступа
- **Проксирование:** YARP для маршрутизации запросов

## AI функции

WebApp использует AI функции для работы с корзиной:
- `GetUserInfo` - получение информации о пользователе
- `SearchCatalog` - поиск товаров в каталоге
- `AddToCart` - добавление товаров в корзину
- `GetCartContents` - получение содержимого корзины

Эти функции позволяют AI понимать контекст и выполнять действия от имени пользователя.

## Маршрутизация

Основные маршруты WebApp:
- `/` - главная страница (каталог)
- `/catalog/{id}` - детали товара
- `/basket` - корзина
- `/checkout` - оформление заказа
- `/orders` - история заказов
- `/chat` - AI чат-бот
