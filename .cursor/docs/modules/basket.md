# Модуль Basket

Модуль Basket отвечает за управление корзиной покупок в системе eShop. Использует Redis для хранения данных корзины и предоставляет gRPC API для работы с корзиной.

## Проекты модуля

### 1. Basket.API

**Назначение:** gRPC API для управления корзиной покупок.

**Ответственность:**
- **gRPC сервис:**
  - `GetBasket` - получение корзины пользователя
  - `UpdateBasket` - обновление корзины (добавление/изменение товаров)
  - `DeleteBasket` - удаление корзины
- **Модели данных:**
  - `CustomerBasket` - корзина покупателя
  - `BasketItem` - элемент корзины (товар с количеством)
- **Репозиторий:**
  - `IBasketRepository` - интерфейс репозитория корзины
  - `RedisBasketRepository` - реализация через Redis
- **Интеграционные события:**
  - `OrderStartedIntegrationEventHandler` - обработка создания заказа
  - Публикация события `OrderStartedIntegrationEvent` при создании заказа
- **Аутентификация:**
  - Интеграция с Identity API
  - Получение идентификатора пользователя из контекста gRPC

**Зависимости:**
- `Aspire.StackExchange.Redis` - клиент Redis
- `Grpc.AspNetCore` - поддержка gRPC
- `EventBusRabbitMQ` - для интеграционных событий
- `eShop.ServiceDefaults` - базовые сервисы Aspire

**Особенности:**
- Использование Redis для хранения корзины (быстрый доступ)
- gRPC вместо REST для лучшей производительности
- Автоматическая очистка корзины при создании заказа
- Интеграция с Event Bus для асинхронной обработки

---

### 2. Basket.UnitTests

**Назначение:** Модульные тесты для Basket API.

**Ответственность:**
- Тесты gRPC сервиса `BasketService`
- Тесты репозитория `RedisBasketRepository`
- Тесты обработчиков интеграционных событий

**Зависимости:**
- `Basket.API`
- `MSTest.Sdk` - фреймворк тестирования
- `NSubstitute` - мокирование зависимостей

**Особенности:**
- Изолированные unit-тесты
- Использование моков для Redis и gRPC контекста
- Тестирование бизнес-логики без инфраструктуры

---

## Архитектура

```
┌─────────────────┐
│  Basket.API     │ ← gRPC API для клиентов
│  (gRPC)         │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
┌───▼────┐ ┌──▼──────────┐
│ Redis  │ │ RabbitMQ    │
│        │ │ Event Bus   │
└────────┘ └────────────┘
```

## Основные потоки данных

### Получение корзины:
1. Клиент вызывает gRPC метод `GetBasket`
2. Извлекается идентификатор пользователя из контекста
3. Данные корзины загружаются из Redis
4. Возвращается корзина или пустая корзина, если не найдена

### Обновление корзины:
1. Клиент вызывает gRPC метод `UpdateBasket` с товарами
2. Корзина обновляется в Redis
3. Возвращается обновленная корзина

### Создание заказа:
1. При создании заказа публикуется `OrderStartedIntegrationEvent`
2. `OrderStartedIntegrationEventHandler` обрабатывает событие
3. Корзина пользователя удаляется из Redis

## Особенности реализации

- **Redis:** Быстрое хранилище для временных данных корзины
- **gRPC:** Высокопроизводительный протокол для внутренней коммуникации
- **Идемпотентность:** Поддержка безопасных повторных операций
- **Автоматическая очистка:** Корзина очищается после создания заказа
- **Масштабируемость:** Redis позволяет горизонтальное масштабирование

## Структура данных в Redis

Корзина хранится в Redis как JSON объект с ключом `basket:{userId}`:
```json
{
  "buyerId": "user123",
  "items": [
    {
      "id": "1",
      "productId": 123,
      "productName": "Product Name",
      "unitPrice": 29.99,
      "oldUnitPrice": 39.99,
      "quantity": 2,
      "pictureUrl": "/images/product.jpg"
    }
  ]
}
```
