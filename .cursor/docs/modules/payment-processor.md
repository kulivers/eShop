# Модуль PaymentProcessor

Модуль PaymentProcessor отвечает за обработку платежей в системе eShop. Работает как фоновый сервис, обрабатывающий интеграционные события о подтверждении заказов.

## Проекты модуля

### 1. PaymentProcessor

**Назначение:** Фоновый сервис для обработки платежей.

**Ответственность:**
- **Обработка платежей:**
  - Подписка на событие `OrderStatusChangedToStockConfirmedIntegrationEvent`
  - Обработка подтвержденных заказов
  - Симуляция процесса оплаты
  - Публикация результата оплаты:
    - `OrderPaymentSucceededIntegrationEvent` - успешная оплата
    - `OrderPaymentFailedIntegrationEvent` - неудачная оплата
- **Конфигурация:**
  - `PaymentOptions` - настройки обработки платежей
  - Возможность настройки вероятности успешной оплаты
  - Настройка задержек обработки

**Зависимости:**
- `EventBusRabbitMQ` - для подписки на события
- `eShop.ServiceDefaults` - базовые сервисы Aspire

**Особенности:**
- Асинхронная обработка через Event Bus
- Симуляция процесса оплаты (для демонстрации)
- Обработка ошибок и повторные попытки
- Интеграция с Ordering API через события

---

## Архитектура

```
┌─────────────────────┐
│ PaymentProcessor    │ ← Фоновый сервис
│ (Background Worker) │
└──────────┬──────────┘
           │
      ┌────┴────┐
      │        │
┌─────▼────┐ ┌─▼──────────┐
│ RabbitMQ │ │ Ordering   │
│ Event Bus│ │ API        │
└──────────┘ └────────────┘
```

## Основные потоки данных

### Обработка платежа:
1. Ordering API публикует `OrderStatusChangedToStockConfirmedIntegrationEvent`
2. PaymentProcessor получает событие через Event Bus
3. Симулируется процесс оплаты:
   - Проверка данных карты
   - Обработка платежа
   - Генерация результата (успех/неудача)
4. Публикуется результат:
   - `OrderPaymentSucceededIntegrationEvent` - при успехе
   - `OrderPaymentFailedIntegrationEvent` - при неудаче
5. Ordering API обрабатывает результат и обновляет статус заказа

### Обработка ошибок:
1. При ошибке обработки платежа публикуется `OrderPaymentFailedIntegrationEvent`
2. Ordering API получает событие и отменяет заказ
3. Пользователь уведомляется о неудачной оплате

## Особенности реализации

- **Event-Driven:** Асинхронная обработка через интеграционные события
- **Симуляция:** Для демонстрационных целей используется симуляция оплаты
- **Надежность:** Обработка ошибок и повторные попытки
- **Масштабируемость:** Может быть развернут в нескольких экземплярах
- **Изоляция:** Независимый сервис, не влияющий на другие компоненты

## Конфигурация

```json
{
  "PaymentOptions": {
    "SuccessRate": 0.95,  // 95% успешных платежей
    "ProcessingDelay": 2000  // Задержка обработки в мс
  }
}
```

## Интеграция с Ordering

PaymentProcessor интегрируется с Ordering API через события:
- Получает: `OrderStatusChangedToStockConfirmedIntegrationEvent`
- Публикует: `OrderPaymentSucceededIntegrationEvent` или `OrderPaymentFailedIntegrationEvent`

Это позволяет асинхронно обрабатывать платежи без блокировки основного потока создания заказов.
