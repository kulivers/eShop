---
name: Вынос миграций в отдельный сервис
overview: Создание отдельного MigrationService проекта для выполнения миграций базы данных по образцу aspire-samples, с переносом существующих миграций и обновлением конфигурации
todos:
  - id: create-migration-service-project
    content: Создать проект PasswordManager.MigrationService (Worker SDK) с необходимыми зависимостями
    status: pending
  - id: move-migrations
    content: Переместить файлы миграций из PasswordManager.Startup/Migrations в PasswordManager.MigrationService/Migrations
    status: pending
    dependencies:
      - create-migration-service-project
  - id: create-database-initializer
    content: Создать DatabaseInitializer.cs (BackgroundService) для выполнения миграций
    status: pending
    dependencies:
      - create-migration-service-project
  - id: create-migration-program
    content: Создать Program.cs для MigrationService с регистрацией DbContext и BackgroundService
    status: pending
    dependencies:
      - create-migration-service-project
  - id: update-apphost
    content: "Обновить AppHost.cs: добавить migrationService и настроить WaitForCompletion"
    status: pending
    dependencies:
      - create-migration-program
  - id: update-dbcontext-config
    content: Обновить MigrationsAssembly в ConfigureLoggingService.cs и RepositoryContextFactory.cs
    status: pending
    dependencies:
      - move-migrations
  - id: remove-db-initialization-handler
    content: Удалить DatabaseInitializationHandler из основного приложения и его регистрацию
    status: pending
    dependencies:
      - update-apphost
  - id: update-csproj-files
    content: "Обновить .csproj файлы: удалить Migrations из Startup, настроить MigrationService"
    status: pending
    dependencies:
      - move-migrations
---

# Вынос миграций в отдельный сервис

## Обзор изменений

Создание отдельного Worker-проекта `PasswordManager.MigrationService` для выполнения миграций базы данных по образцу `database-migrations` из aspire-samples. Миграции будут выполняться как отдельный сервис в Aspire, который запускается перед основным API сервисом.

## Архитектура

```javascript
AppHost
  ├── postgres (база данных)
  ├── migration (MigrationService - выполняется первым)
  └── passwordmanagerapi (основной API - ждет завершения migration)
```



## Изменяемые файлы

### 1. Новые файлы

**PasswordManager/PasswordManager.MigrationService/PasswordManager.MigrationService.csproj**

- Worker проект с зависимостями на EF Core Tools, PostgreSQL, Aspire
- Ссылки на Repository и ServiceDefaults проекты

**PasswordManager/PasswordManager.MigrationService/Program.cs**

- Регистрация BackgroundService для миграций
- Настройка DbContext с указанием сборки миграций

**PasswordManager/PasswordManager.MigrationService/DatabaseInitializer.cs**

```csharp
using System.Diagnostics;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;
using OpenTelemetry.Trace;
using PasswordManager.Repository;

namespace PasswordManager.MigrationService;

public class DatabaseInitializer(
    IServiceProvider serviceProvider,
    IHostEnvironment hostEnvironment,
    IHostApplicationLifetime hostApplicationLifetime,
    ILogger<DatabaseInitializer> logger) : BackgroundService
{
    private readonly ActivitySource _activitySource = new(hostEnvironment.ApplicationName);

    protected override async Task ExecuteAsync(CancellationToken cancellationToken)
    {
        using var activity = _activitySource.StartActivity(hostEnvironment.ApplicationName, ActivityKind.Client);

        try
        {
            logger.LogInformation("Starting database migration");

            using var scope = serviceProvider.CreateScope();
            var dbContext = scope.ServiceProvider.GetRequiredService<RepositoryContext>();

            await RunMigrationAsync(dbContext, cancellationToken);

            logger.LogInformation("Database migration completed successfully");
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "An error occurred while running database migrations");
            activity?.AddException(ex);
            throw;
        }

        hostApplicationLifetime.StopApplication();
    }

    private static async Task RunMigrationAsync(
        RepositoryContext dbContext,
        CancellationToken cancellationToken)
    {
        var strategy = dbContext.Database.CreateExecutionStrategy();
        await strategy.ExecuteAsync(async () =>
        {
            await dbContext.Database.MigrateAsync(cancellationToken);
        });
    }
}
```

**PasswordManager/PasswordManager.MigrationService/Migrations/** (перемещенные файлы)

- `20250928100222_InitialCreate.cs`
- `20250928100222_InitialCreate.Designer.cs`
- `RepositoryContextModelSnapshot.cs`

### 2. Изменяемые файлы

**AspireJavaScript.AppHost/AppHost.cs**

```csharp
// Добавить после создания passwordManagerDb:
var migrationService = builder.AddProject<Projects.PasswordManager_MigrationService>("migration")
    .WithReference(passwordManagerDb)
    .WaitFor(postgres);

// Изменить существующий вызов:
var passwordManager = builder.AddProject<Projects.PasswordManager_Startup>("passwordmanagerapi")
    .WithReference(passwordManagerDb)
    .WaitForCompletion(migrationService)  // Ждет завершения миграций
    .WaitFor(postgres)
    .WithHttpEndpoint(
        targetPort: 8081,
        name: "passwordmanagerapi")
    .WithExternalHttpEndpoints();
```

**PasswordManager/PasswordManager.Startup/Extensions/ConfigureLoggingService.cs**

```csharp
// Изменить MigrationsAssembly (строка 19):
builder.UseNpgsql(dbConfig.ConnectionString,
    optionsBuilder =>
    {
        optionsBuilder.MigrationsAssembly("PasswordManager.MigrationService");
    });
```

**PasswordManager/PasswordManager.Startup/ContextFactory/RepositoryContextFactory.cs**

```csharp
// Изменить MigrationsAssembly (строка 26):
var builder = new DbContextOptionsBuilder<RepositoryContext>()
    .UseNpgsql(connectionString, builder => builder.MigrationsAssembly("PasswordManager.MigrationService"));
```

**PasswordManager/PasswordManager.Startup/PasswordManager.Startup.csproj**

- Удалить папку Migrations из ItemGroup
- Удалить зависимость на Microsoft.EntityFrameworkCore.Tools (если не используется)

**PasswordManager/PasswordManager.Startup/Program.cs**

```csharp
// Удалить строки 28:
// builder.Services.AddSingleton<IApplicationStartupHandler, DatabaseInitializationHandler>();
```

**PasswordManager/PasswordManager.Startup/ApplicationLifecycle/Handlers/DatabaseInitializationHandler.cs**

- Удалить файл (миграции теперь выполняются отдельным сервисом)

## Детали реализации

### DatabaseInitializer.cs

- Наследуется от `BackgroundService`
- Использует `ActivitySource` для телеметрии
- Выполняет миграции через `CreateExecutionStrategy` для надежности
- Завершает приложение после успешного выполнения (`hostApplicationLifetime.StopApplication()`)

### Program.cs (MigrationService)

- Использует `AddDbContextPool` для оптимизации
- Указывает `MigrationsAssembly("PasswordManager.MigrationService")`
- Использует `EnrichNpgsqlDbContext` для интеграции с Aspire

### AppHost.cs

- MigrationService запускается первым и ждет готовности PostgreSQL
- Основной API сервис ждет завершения MigrationService через `WaitForCompletion`

## Порядок выполнения

1. Создать проект `PasswordManager.MigrationService`
2. Переместить файлы миграций
3. Создать `DatabaseInitializer.cs`
4. Создать `Program.cs` для MigrationService
5. Обновить `AppHost.cs`
6. Обновить `ConfigureLoggingService.cs` и `RepositoryContextFactory.cs`
7. Удалить `DatabaseInitializationHandler` из основного приложения
8. Обновить `.csproj` файлы

## Зависимости MigrationService

- `Microsoft.NET.Sdk.Worker`
- `Microsoft.EntityFrameworkCore.Tools` (PrivateAssets)
- `Npgsql.EntityFrameworkCore.PostgreSQL`